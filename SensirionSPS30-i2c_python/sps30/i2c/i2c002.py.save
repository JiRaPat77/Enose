import io
from fcntl import ioctl
import time

I2C_SLAVE = 0x0703

class I2C:

    def __init__(self, bus: int, address: int):
        self.fr = io.open("/dev/i2c-" + str(bus), "rb", buffering=0)
        self.fw = io.open("/dev/i2c-" + str(bus), "wb", buffering=0)

        # set device address
        ioctl(self.fr, I2C_SLAVE, address)
        ioctl(self.fw, I2C_SLAVE, address)

    def write(self, data: list):
        self.fw.write(bytearray(data))

    def read(self, nbytes: int) -> list:
        attempts = 5  # จำนวนครั้งที่พยายามอ่าน
        for i in range(attempts):
            try:
                return list(self.fr.read(nbytes))
            except OSError as e:
                if e.errno == 121:  # Remote I/O error
                    time.sleep(0.1)  # รอแล้วลองใหม่
                else:
                    raise
        raise OSError("Failed to read from I2C device after multiple attempts")

    def close(self):
        self.fw.close()
        self.fr.close()
